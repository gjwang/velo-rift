# RFC-0048: SIP Bypass via PATH Shim (Inception Mode)

## Status: ACTIVE (Phase 1 Complete)

> **Original Approach (Binary Shadowing)**: âŒ NOT VIABLE (Killed: 9 on ARM64)
> **Current Approach (PATH Shim / Inception Mode)**: âœ… PROVEN & IMPLEMENTED

---

## 1. Problem Statement

On macOS, **System Integrity Protection (SIP)** prevents `DYLD_INSERT_LIBRARIES` from injecting into binaries in protected directories (`/bin`, `/usr/bin`, etc.). When build systems invoke shell commands like `chmod`, `rm`, `cp`, the Velo Rift shim is bypassed.

### Scope of Impact

| Call Type | Shim Intercepts? | Example |
|-----------|-----------------|---------|
| Direct syscall (C/Rust) | âœ… Yes | `chmod("file", 0755)` |
| Python/Node/Go stdlib | âœ… Yes | `os.chmod()`, `fs.chmod()` |
| Shell command | âŒ No | `$(shell chmod 755 file)` |
| Makefile shell | âŒ No | `chmod 755 $(TARGET)` |

---

## 2. Design Philosophy

### 2.1 What We're NOT Doing

| âŒ Rejected Approach | Why |
|---------------------|-----|
| Binary Shadowing    | `Killed: 9` on ARM64 due to signature mismatch on system binary copies |
| Global LD_PRELOAD   | Too dangerous, breaks system |
| ptrace / syscall hook | Security nightmare |
| Replace /bin/bash   | Instant user revolt |

### 2.2 What We ARE Doing

**Command-level interposition** (å‘½ä»¤çº§é€æ˜ä»£ç†)

```
User types: npm install
Shell resolves: npm â†’ shim â†’ real npm
```

This is the same approach used by:
- **ccache/sccache** - compiler wrapper
- **asdf/mise** - version manager shims
- **direnv** - shell hook auto-activation
- **rustup** - toolchain proxy
- **pyenv/nvm** - language version manager

---

## 3. Security Tier System

### Level 0: PATH-based Command Shadowing (RECOMMENDED)

This is the **primary and safest** approach.

```
~/.vrift/bin/npm   â† shim wrapper
/usr/bin/npm       â† real binary
```

**Mechanism:**
1. During `vrift inception`:
   ```bash
   export PATH="$PROJECT/.vrift/bin:$PATH"
   ```
2. `.vrift/bin/npm` does three things:
   - Parse current cwd / env
   - Prepare VFS mount / overlay
   - `execve(real_npm, args, modified_env)`

**Advantages:**
- âœ… Completely user-space
- âœ… Can opt-in / opt-out
- âœ… Same legitimacy as pyenv/nvm/rustup
- âœ… Clear security model
- âœ… Enterprise-acceptable

### Level 1: Shell Integration (Optional Enhancement)

Shell hooks for **proactive preparation**, not interception:

| Shell | Hook |
|-------|------|
| bash | `PROMPT_COMMAND` |
| zsh | `preexec` / `precmd` |
| fish | `--on-event fish_preexec` |

**Purpose:**
```
User hits Enter
       â†“
Shell hook sees: npm install
       â†“
Warm up VFS mount / daemon connection
       â†“
Command executes (still real npm)
```

**Benefit:** Reduce cold-start latency without modifying command resolution.

### Level 2: DYLD Shim (Current Implementation)

For binaries that **do** load the shim (non-SIP):
- Python scripts, Node programs, compiled user binaries
- Works via `DYLD_INSERT_LIBRARIES`

### Level 3: âŒ Rejected (Danger Zone)

These approaches are explicitly **NOT** used:
- Global LD_PRELOAD without user consent
- Kernel LSM / fanotify forced redirection
- ptrace I/O injection

---

## 4. Implementation: Inception Mode

### 4.1 Concept: "Inception"

Inspired by the movie (ç›—æ¢¦ç©ºé—´), entering VFS mode is like entering a dream layer:

- **`vrift inception`** - Enter the dream (activate VFS environment)
- **`vrift wake`** - Exit the dream (deactivate VFS environment)
- **Shell totem** - `(vrift ğŸŒ€)` prompt indicates you're "in the dream"

### 4.2 Current Implementation (Phase 1 âœ…)

#### Commands

| Command | Status | Description |
|---------|--------|-------------|
| `vrift inception [dir]` | âœ… Implemented | Output shell script for `eval` |
| `vrift wake` | âœ… Implemented | Restore environment |
| `vrift hook <shell>` | âœ… Implemented | Auto-inception on cd |

#### Environment Variables Set

```bash
export VRIFT_PROJECT_ROOT="/path/to/project"
export VRIFT_INCEPTION=1
export VRIFT_MANIFEST="$VRIFT_PROJECT_ROOT/.vrift/manifest.lmdb"
export PATH="$VRIFT_PROJECT_ROOT/.vrift/bin:$PATH"
export DYLD_INSERT_LIBRARIES="/path/to/libvrift_shim.dylib"
export DYLD_FORCE_FLAT_NAMESPACE=1
export _VRIFT_OLD_PS1="$PS1"
export PS1="(vrift ğŸŒ€) $PS1"
```

### 4.3 Pending Implementation (Phase 2)

#### Wrapper Generation

`.vrift/bin/` needs wrapper scripts for SIP-protected commands:

**Directory Structure:**
```
.vrift/
â”œâ”€â”€ bin/
â”‚   â”œâ”€â”€ chmod      â† wrapper script
â”‚   â”œâ”€â”€ rm         â† wrapper script
â”‚   â”œâ”€â”€ cp         â† wrapper script
â”‚   â”œâ”€â”€ cat        â† wrapper script
â”‚   â””â”€â”€ ...
â”œâ”€â”€ helpers/
â”‚   â”œâ”€â”€ tiny_chmod  â† minimalist C helper (Interception-ready)
â”‚   â”œâ”€â”€ tiny_cat    â† minimalist C helper (Interception-ready)
â”‚   â””â”€â”€ ...
â””â”€â”€ manifest.lmdb
```

**Wrapper Script Example (`.vrift/bin/chmod`):**
```bash
#!/bin/bash
# Auto-generated by vrift inception
# Inception-aware chmod wrapper

TARGET="${@: -1}"
[[ "$TARGET" != /* ]] && TARGET="$(pwd)/$TARGET"

if [[ "$TARGET" == "$VRIFT_PROJECT_ROOT"* ]]; then
    # VFS path: use helper that loads shim
    exec "$VRIFT_PROJECT_ROOT/.vrift/helpers/vrift-chmod" "$@"
else
    # Non-VFS path: passthrough to real binary
    exec /bin/chmod "$@"
fi
```

---

## 5. User Experience

### 5.1 Manual Inception

```bash
$ cd my-project
$ eval "$(vrift inception)"
ğŸŒ€ INCEPTION: Entering the dream...
   âœ” VFS layer active
   âœ” Reality distorted. Happy hacking.

(vrift ğŸŒ€) $ cargo build   # All I/O goes through VFS
(vrift ğŸŒ€) $ make install  # chmod/cp in Makefile intercepted!

(vrift ğŸŒ€) $ eval "$(vrift wake)"
ğŸ’« WAKE: Back to reality
   Environment restored
$
```

### 5.2 Automatic Inception (Shell Hook)

```bash
# Add to ~/.zshrc
eval "$(vrift hook zsh)"

# Now inception is automatic:
$ cd my-project/        # Auto-inception if .vrift/ exists
ğŸŒ€ Auto-entering dream layer...
(vrift ğŸŒ€) $ 

(vrift ğŸŒ€) $ cd ../     # Auto-wake when leaving
ğŸ’« Auto-waking...
$
```

---

## 6. Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         User Shell (bash/zsh)                       â”‚
â”‚                                                                     â”‚
â”‚  eval "$(vrift inception)"                                          â”‚
â”‚         â†“                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Environment Modified                            â”‚   â”‚
â”‚  â”‚  PATH=".vrift/bin:$PATH"  DYLD_INSERT_LIBRARIES=... set     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  User types: chmod 644 src/main.rs                                  â”‚
â”‚         â†“                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ Shell PATH      â”‚                                               â”‚
â”‚  â”‚ Resolution      â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚           â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ .vrift/bin/chmod (wrapper script)      â”‚                        â”‚
â”‚  â”‚                                         â”‚                        â”‚
â”‚  â”‚  if path in VFS:                        â”‚                        â”‚
â”‚  â”‚    exec .vrift/helpers/vrift-chmod      â”‚  â† Loads shim!        â”‚
â”‚  â”‚  else:                                  â”‚                        â”‚
â”‚  â”‚    exec /bin/chmod                      â”‚  â† Passthrough        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                     â”‚
â”‚  vrift-chmod loads libvrift_shim.dylib â†’ IPC to vriftd â†’ VFS Op    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Implementation Plan

### Phase 1: CLI Commands âœ… COMPLETE
- [x] Implement `vrift inception` - output shell env setup
- [x] Implement `vrift wake` - output shell env cleanup
- [x] Implement `vrift hook <shell>` - output shell hook code
- [x] Theatrical animations and prompt indicator

### Phase 2: Wrapper Generation ğŸ”œ NEXT
- [ ] Generate `.vrift/bin/` wrappers during `vrift init` or first `inception`
- [ ] Target commands: `chmod`, `chown`, `rm`, `cp`, `mv`, `touch`, `mkdir`, `rmdir`
- [ ] Make wrappers executable and self-contained

### Phase 3: Helper Binaries âœ… VERIFIED
- [x] Compile shim-loadable helper binaries (`tiny_chmod`, `tiny_cat`) âœ…
- [x] Verified bypass of `Killed: 9` via ad-hoc signed local helper âœ…
- [ ] Bundle common helpers with Velo Rift distribution

### Phase 4: Build System Integration
- [ ] Test with Makefile-based projects
- [ ] Test with npm/yarn scripts
- [ ] Test with cargo build scripts
- [ ] Document common patterns

---

## 8. Security Considerations

| Concern | Mitigation |
|---------|------------|
| Wrapper scripts execute arbitrary code? | No - they only exec real binaries or vrift helpers |
| PATH poisoning attack? | Only within Inception Mode, user must explicitly opt-in |
| Privilege escalation? | No elevation; runs as current user |
| Persistent after reboot? | No - environment is per-shell session |
| Affects other users? | No - user-space PATH modification only |

---

## 9. Comparison with Previous Approach

| Aspect | Binary Shadowing | Inception Mode |
|--------|------------------|----------------|
| macOS Compatibility | âŒ Blocked by kernel | âœ… Works |
| Zero Configuration | âœ… Intended | âš ï¸ Requires `vrift inception` |
| Project Isolation | âœ… Yes | âœ… Yes |
| Performance | Good (cached) | Good (instant) |
| Security Changes | None | None |
| User Experience | Transparent | Explicit (like virtualenv) |
| Industry Precedent | None | âœ… Same as pyenv/rustup |

---

## 10. References

- [ccache documentation](https://ccache.dev/manual.html) - PATH-based compiler wrapper
- [mise documentation](https://mise.jdx.dev/) - Version manager with shims
- [direnv](https://direnv.net/) - Shell environment auto-switching
- [Inception (2010)](https://en.wikipedia.org/wiki/Inception) - Dream layer metaphor ğŸŒ€
