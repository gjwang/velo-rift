#!/bin/bash
# =============================================================================
# VRift Pre-commit Hook (Optimized - Only check changed file types)
# =============================================================================
# Auto-format and auto-fix safe issues before commit.
# Skip checks for file types that weren't modified.
# =============================================================================

set -e

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any Rust files are staged
HAS_RUST_FILES=$(echo "$STAGED_FILES" | grep -E '\.rs$' || true)

# Check if any Python files are staged
HAS_PYTHON_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$' || true)

# =============================================================================
# Rust checks (only if .rs files are staged)
# =============================================================================
if [ -n "$HAS_RUST_FILES" ]; then
    echo "ğŸ¨ Auto-formatting with cargo fmt..."
    cargo fmt

    echo "ğŸ”§ Auto-fixing clippy (machine-applicable only)..."
    cargo clippy --fix --allow-staged --allow-dirty --workspace --exclude vrift-fuse --exclude vrift-shim --all-targets || true

    echo "ğŸ” Running cargo clippy check..."
    cargo clippy --workspace --exclude vrift-fuse --exclude vrift-shim --lib --bins -- -D warnings || {
        echo "âŒ Clippy check failed. Some warnings cannot be auto-fixed."
        exit 1
    }

    echo "ğŸ“ Re-staging auto-fixed Rust files..."
    git add -u
else
    echo "â­ï¸  No Rust files changed, skipping cargo fmt/clippy"
fi

# =============================================================================
# Python checks (only if .py files are staged)
# =============================================================================
if [ -n "$HAS_PYTHON_FILES" ]; then
    echo "ğŸ Auto-fixing Python (Ruff)..."
    uv run ruff check --fix tests/ scripts/ || true
    uv run ruff format tests/ scripts/ || true

    echo "ğŸ“ Re-staging Python auto-fixed files..."
    git add -u

    echo "ğŸ” Running mypy type check..."
    if command -v pre-commit &>/dev/null; then
        pre-commit run mypy --all-files || {
            echo "âŒ Mypy check failed."
            exit 1
        }
    fi
else
    echo "â­ï¸  No Python files changed, skipping ruff/mypy"
fi

# =============================================================================
# Always run basic pre-commit checks (trailing whitespace, etc.)
# =============================================================================
if command -v pre-commit &>/dev/null; then
    echo "ğŸ” Running basic pre-commit checks..."
    pre-commit run trailing-whitespace --all-files || true
    pre-commit run end-of-file-fixer --all-files || true
    pre-commit run check-yaml --all-files || true
    pre-commit run check-added-large-files --all-files || true
fi

echo "âœ… All pre-commit checks passed!"
